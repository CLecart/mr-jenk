FROM jenkins/inbound-agent:latest-jdk17

# Install Node.js 20 and Docker CLI (client only) as root
USER root

# Install common packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg2 apt-transport-https lsb-release sudo && rm -rf /var/lib/apt/lists/*

# Install Node.js 20
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
 && apt-get update && apt-get install -y --no-install-recommends nodejs && rm -rf /var/lib/apt/lists/*

# Install Docker CLI: prefer package, fallback to static binary if package not available
RUN apt-get update && apt-get install -y --no-install-recommends docker.io && rm -rf /var/lib/apt/lists/* \
    || (echo "docker.io package install failed, fetching static docker client" && \
            curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-24.0.5.tgz" -o /tmp/docker.tgz && \
            tar -xzf /tmp/docker.tgz -C /tmp && mv /tmp/docker/docker /usr/local/bin/docker && chmod +x /usr/local/bin/docker && rm -f /tmp/docker.tgz)

# Ensure docker client binary exists: fallback to static binary if package didn't provide it
RUN if ! command -v docker >/dev/null 2>&1; then \
            echo "docker client missing, installing static client"; \
            curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-24.0.5.tgz" -o /tmp/docker.tgz && \
            tar -xzf /tmp/docker.tgz -C /tmp && mv /tmp/docker/docker /usr/local/bin/docker && chmod +x /usr/local/bin/docker && rm -f /tmp/docker.tgz; \
        fi

# Ensure Java binaries are available on PATH (some base images install in /opt/java)
RUN if [ -x /opt/java/openjdk/bin/java ] && [ ! -e /usr/local/bin/java ]; then \
            ln -s /opt/java/openjdk/bin/java /usr/local/bin/java; \
            ln -s /opt/java/openjdk/bin/javac /usr/local/bin/javac || true; \
        fi

# Verify docker exists (best-effort). If missing, the image build will still succeed but `docker` may be unavailable.
RUN command -v docker || true

# Keep default user from base image (jenkins) and default entrypoint
USER jenkins
WORKDIR /home/jenkins

